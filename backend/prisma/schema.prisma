generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =========================
// Enums
// =========================

enum UserRole {
  ADMIN
  ASSISTANT
  REVIEWER
}

enum PericiaPaymentStatus {
  PENDENTE
  PARCIAL
  PAGO
  ATRASADO
}

enum FontePagamento {
  TJ
  PARTE_AUTORA
  PARTE_RE
  SEGURADORA
  OUTRO
}

enum AgendaEventType {
  PERICIA
  PERICIA_AGENDADA
  PRAZO
  LAUDO
  DESLOCAMENTO
  BLOQUEIO
  BLOCO_LAUDO
  BLOCO_TRABALHO
  OUTRO
}

enum AgendaEventStatus {
  AGENDADA
  REALIZADA
  FALTOU
  REMARCADA
  CANCELADA
}

enum AgendaEventSource {
  MANUAL
  CNJ
  GOOGLE_CALENDAR
  IMPORTACAO
  IA
  OUTRO
}

enum ExternalSyncStatus {
  PENDING
  SYNCED
  ERROR
  CONFLICT
  DISABLED
}

enum AgendaTaskStatus {
  TODO
  DOING
  DONE
  CANCELED
}

enum TelepericiaSlotType {
  SEQUENTIAL
  CUSTOM
}

enum CnjSyncStatus {
  PENDING
  SUCCESS
  ERROR
  RETRY
}

enum FinancialDirection {
  IN
  OUT
}

enum PaymentMatchStatus {
  MATCHED
  UNMATCHED
  PARTIAL
}

enum RuleTrigger {
  ON_STATUS_ENTER
  ON_FIELD_SET
  ON_FIN_EVENT_CREATED
  CRON
}

enum RuleAction {
  UPDATE_FIELD
  CREATE_TASK
  SEND_EMAIL
  SEND_NOTIFICATION
  WEBHOOK
}

enum ExamStatus {
  NOT_STARTED
  IN_PROGRESS
  DONE
}

enum NotificationChannel {
  EMAIL
  SMS
  PUSH
  WHATSAPP
}

enum CalendarSyncType {
  EVENT
  TASK
}

enum CalendarSyncDirection {
  PUSH
  PULL
}

enum CalendarSyncStatus {
  PENDING
  SYNCED
  WARNING
  CONFLICT
  ERROR
}

enum CalendarSyncMode {
  MIRROR
  TWO_WAY
}

// =========================
// Identity / Tenant
// =========================

model Tenant {
  id        String   @id @default(uuid()) @db.Uuid
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?  @db.Uuid
  updatedBy String?  @db.Uuid

  users               User[]
  userProfiles        UserProfile[]
  pericias            Pericia[]
  cidades             Cidade[]
  varas               Vara[]
  tribunais           Tribunal[]
  tiposPericia        TipoPericia[]
  modalidades         Modalidade[]
  statuses            Status[]
  locais              Local[]
  lawyers             Lawyer[]
  caseDocuments       CaseDocument[]
  lawyerOnPericias    LawyerOnPericia[]
  preLaudos           PreLaudo[]
  examPlans           ExamPlan[]
  examsPerformed      ExamPerformed[]
  physicalManeuvers   PhysicalManeuver[]
  knowledgeItems      KnowledgeItem[]
  agendaEvents        AgendaEvent[]
  agendaTasks         AgendaTask[]
  calendarIntegrations CalendarIntegration[]
  syncAuditLogs       SyncAuditLog[]
  recebimentos        Recebimento[]
  importBatches       ImportBatch[]
  unmatchedPayments   UnmatchedPayment[]
  despesas            Despesa[]
  bankTransactions    BankTransaction[]
  cashLedgerItems     CashLedgerItem[]
  paymentProfiles     PaymentProfile[]
  payers              Payer[]
  smartRules          SmartRule[]
  automationRules     AutomationRule[]
  logStatuses         LogStatus[]
  activityLogs        ActivityLog[]
  whatsappMessages    WhatsappMessage[]
  dailyUsage          DailyUsage[]
  emailConfigs        EmailConfig[]
  emailTemplates      EmailTemplate[]
  messageTemplates    MessageTemplate[]
  integrationSettings IntegrationSettings[]
  notificationConfigs NotificationConfig[]
  teleSlots           TelepericiaSlot[]
  teleSlotItems       TelepericiaSlotItem[]
  schedulingBatches   SchedulingBatch[]
  cnjSyncs            CnjSync[]
  whatsAppJobs        WhatsAppJob[]
}

model User {
  id              String       @id @default(uuid()) @db.Uuid
  tenantId        String       @db.Uuid
  email           String       @unique
  passwordHash    String?
  role            UserRole
  isActive        Boolean      @default(true)
  lastLoginAt     DateTime?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  createdBy       String?      @db.Uuid
  updatedBy       String?      @db.Uuid
  tenant          Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  profile         UserProfile?
  lockedPreLaudos PreLaudo[]   @relation("PreLaudoLockedBy")

  @@index([tenantId, role])
}

model UserProfile {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String   @db.Uuid
  userId      String   @unique @db.Uuid
  fullName    String
  cpf         String?
  phone       String?
  avatarUrl   String?
  specialty   String?
  preferences Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?  @db.Uuid
  updatedBy   String?  @db.Uuid
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId, fullName])
}

// =========================
// Catálogos
// =========================

model Cidade {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid
  nome      String
  uf        String   @db.Char(2)
  ibgeCode  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?  @db.Uuid
  updatedBy String?  @db.Uuid

  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  varas       Vara[]
  pericias    Pericia[]
  locais      Local[]
  agendaEvents AgendaEvent[]
  schedulingBatches SchedulingBatch[]

  @@unique([tenantId, nome, uf])
  @@index([tenantId, nome])
}

model Tribunal {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid
  nome      String
  sigla     String
  esfera    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?  @db.Uuid
  updatedBy String?  @db.Uuid

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  varas  Vara[]

  @@unique([tenantId, sigla])
}

model Vara {
  id         String   @id @default(uuid()) @db.Uuid
  tenantId   String   @db.Uuid
  cidadeId   String   @db.Uuid
  tribunalId String?  @db.Uuid
  nome       String
  codigo     String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  createdBy  String?  @db.Uuid
  updatedBy  String?  @db.Uuid

  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  cidade   Cidade    @relation(fields: [cidadeId], references: [id], onDelete: Restrict)
  tribunal Tribunal? @relation(fields: [tribunalId], references: [id], onDelete: SetNull)
  pericias Pericia[]

  @@index([tenantId, cidadeId])
}

model TipoPericia {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid
  codigo    String
  nome      String
  descricao String?
  ativo     Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?  @db.Uuid
  updatedBy String?  @db.Uuid

  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  pericias Pericia[]

  @@unique([tenantId, codigo])
}

model Modalidade {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid
  codigo    String
  nome      String
  ativo     Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?  @db.Uuid
  updatedBy String?  @db.Uuid

  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  pericias Pericia[]

  @@unique([tenantId, codigo])
}

model Status {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid
  codigo    String
  nome      String
  cor       String?
  ordem     Int      @default(0)
  ativo     Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?  @db.Uuid
  updatedBy String?  @db.Uuid

  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  pericias Pericia[]

  @@unique([tenantId, codigo])
  @@index([tenantId, ordem])
}

model Local {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String   @db.Uuid
  cidadeId    String?  @db.Uuid
  nome        String
  endereco    String?
  latitude    Decimal? @db.Decimal(10, 7)
  longitude   Decimal? @db.Decimal(10, 7)
  observacoes String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?  @db.Uuid
  updatedBy   String?  @db.Uuid

  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  cidade   Cidade?   @relation(fields: [cidadeId], references: [id], onDelete: SetNull)
  pericias Pericia[]

  @@index([tenantId, cidadeId])
}

// =========================
// Domínio principal
// =========================

model Pericia {
  id                          String               @id @default(uuid()) @db.Uuid
  tenantId                    String               @db.Uuid
  processoCNJ                 String
  processoCNJDigits           String?
  cidadeId                    String?              @db.Uuid
  varaId                      String?              @db.Uuid
  tipoPericiaId               String?              @db.Uuid
  modalidadeId                String?              @db.Uuid
  statusId                    String?              @db.Uuid
  localId                     String?              @db.Uuid
  juizNome                    String?
  autorNome                   String?
  reuNome                     String?
  periciadoNome               String?
  periciadoCpf                String?
  periciadoNascimento         DateTime?
  observacoes                 String?
  extraObservation            String?
  esclarecimentos             Json?
  checklist                   Json?
  anexosResumo                Json?
  isUrgent                    Boolean              @default(false)
  urgentCheckedAt             DateTime?
  agendada                    Boolean              @default(false)
  laudoEnviado                Boolean              @default(false)
  finalizada                  Boolean              @default(false)
  pagamentoStatus             PericiaPaymentStatus @default(PENDENTE)
  honorariosPrevistosJG       Decimal?             @db.Decimal(12, 2)
  honorariosPrevistosPartes   Decimal?             @db.Decimal(12, 2)
  valorRecebidoTotal          Decimal?             @db.Decimal(12, 2)
  dataNomeacao                DateTime?
  dataAgendamento             DateTime?
  horaAgendamento             String?
  dataRealizacao              DateTime?
  dataEnvioLaudo              DateTime?
  origemImportacao            String?
  dataUltimaMovimentacaoCnj   DateTime?
  telepericiaStatusChangedAt  DateTime?
  whatsappStatus              String?
  telepericiaConfirmedAt      DateTime?
  telepericiaLastAttemptAt    DateTime?
  metadata                    Json?
  deletedAt                   DateTime?
  createdAt                   DateTime             @default(now())
  updatedAt                   DateTime             @updatedAt
  createdBy                   String?              @db.Uuid
  updatedBy                   String?              @db.Uuid

  tenant      Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  cidade      Cidade?      @relation(fields: [cidadeId], references: [id], onDelete: SetNull)
  vara        Vara?        @relation(fields: [varaId], references: [id], onDelete: SetNull)
  tipoPericia TipoPericia? @relation(fields: [tipoPericiaId], references: [id], onDelete: SetNull)
  modalidade  Modalidade?  @relation(fields: [modalidadeId], references: [id], onDelete: SetNull)
  status      Status?      @relation(fields: [statusId], references: [id], onDelete: SetNull)
  local       Local?       @relation(fields: [localId], references: [id], onDelete: SetNull)

  lawyers          LawyerOnPericia[]
  caseDocuments    CaseDocument[]
  preLaudo         PreLaudo?
  examPlans        ExamPlan[]
  examsPerformed   ExamPerformed[]
  agendaEvents     AgendaEvent[]
  agendaTasks      AgendaTask[]
  recebimentos     Recebimento[]
  despesas         Despesa[]
  logStatuses      LogStatus[]
  bankTransactions BankTransaction[]
  teleSlots        TelepericiaSlotItem[]
  cnjSyncs         CnjSync[]
  whatsappMessages WhatsappMessage[]

  @@unique([tenantId, processoCNJ])
  @@index([tenantId, processoCNJ])
  @@index([tenantId, cidadeId])
  @@index([tenantId, statusId])
  @@index([tenantId, dataNomeacao])
  @@index([tenantId, dataAgendamento])
  @@index([tenantId, isUrgent, urgentCheckedAt, telepericiaStatusChangedAt, dataAgendamento, createdAt])
}

model WhatsappAccount {
  id                    String   @id @default(uuid()) @db.Uuid
  tenantId              String   @db.Uuid
  wabaId                String
  phoneNumberId         String
  accessTokenEnc        String
  webhookVerifyTokenEnc String
  status                String
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  createdBy             String?  @db.Uuid
  updatedBy             String?  @db.Uuid

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, wabaId, phoneNumberId])
  @@index([tenantId, status])
}

model WhatsappContact {
  id            String    @id @default(uuid()) @db.Uuid
  tenantId      String    @db.Uuid
  phoneE164     String
  consentStatus String?
  consentSource String?
  consentAt     DateTime?
  lastInboundAt DateTime?
  phoneInvalid  Boolean   @default(false)
  flags         Json?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  createdBy     String?   @db.Uuid
  updatedBy     String?   @db.Uuid

  tenant           Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  messages         WhatsappMessage[]
  unlinkedInbounds WhatsappUnlinkedInbound[]

  @@unique([tenantId, phoneE164])
  @@index([tenantId, consentStatus])
}

model WhatsappTemplate {
  id               String   @id @default(uuid()) @db.Uuid
  tenantId         String   @db.Uuid
  name             String
  language         String
  category         String?
  metaTemplateName String?
  variablesSchema  Json?
  status           String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  createdBy        String?  @db.Uuid
  updatedBy        String?  @db.Uuid

  tenant   Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  messages WhatsappMessage[]

  @@unique([tenantId, name, language])
  @@index([tenantId, status])
}

model WhatsappMessage {
  id                String    @id @default(uuid()) @db.Uuid
  tenantId          String    @db.Uuid
  contactId         String?   @db.Uuid
  periciaId         String?   @db.Uuid
  appointmentId     String?
  direction         String
  messageType       String
  templateId        String?   @db.Uuid
  payloadJson       Json?
  providerMessageId String?
  status            String
  erro              String?
  sentAt            DateTime?
  deliveredAt       DateTime?
  readAt            DateTime?
  failedAt          DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  createdBy         String?   @db.Uuid
  updatedBy         String?   @db.Uuid

  tenant   Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  contact  WhatsappContact?  @relation(fields: [contactId], references: [id], onDelete: SetNull)
  pericia  Pericia?          @relation(fields: [periciaId], references: [id], onDelete: SetNull)
  template WhatsappTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)

  @@index([tenantId, contactId, createdAt])
  @@index([providerMessageId])
}

model WhatsappJob {
  id             String    @id @default(uuid()) @db.Uuid
  tenantId       String    @db.Uuid
  periciaId      String?   @db.Uuid
  appointmentId  String?
  jobType        String
  scheduledFor   DateTime?
  status         String
  attempts       Int       @default(0)
  lastError      String?
  idempotencyKey String    @map("idempotency_key")
  payloadJson    Json?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  createdBy      String?   @db.Uuid
  updatedBy      String?   @db.Uuid

  tenant  Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  pericia Pericia? @relation(fields: [periciaId], references: [id], onDelete: SetNull)

  @@unique([idempotencyKey])
  @@index([tenantId, status, scheduledFor])
  @@map("whatsapp_jobs")
}

model WhatsappUnlinkedInbound {
  id                String   @id @default(uuid()) @db.Uuid
  tenantId          String   @db.Uuid
  contactId         String?  @db.Uuid
  periciaId         String?  @db.Uuid
  fromPhone         String
  text              String?
  providerMessageId String?
  receivedAt        DateTime
  status            String
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  createdBy         String?  @db.Uuid
  updatedBy         String?  @db.Uuid

  tenant  Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  contact WhatsappContact? @relation(fields: [contactId], references: [id], onDelete: SetNull)
  pericia Pericia?         @relation(fields: [periciaId], references: [id], onDelete: SetNull)

  @@index([tenantId, fromPhone, receivedAt])
  @@index([providerMessageId])
}

model MessageTemplate {
  id           String              @id @default(uuid()) @db.Uuid
  tenantId     String              @db.Uuid
  name         String
  title        String?
  channel      NotificationChannel
  body         String
  placeholders Json?
  metaMappings Json?
  active       Boolean             @default(true)
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  createdBy    String?             @db.Uuid
  updatedBy    String?             @db.Uuid

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, name, channel])
  @@index([tenantId, channel, active])
}

model TelepericiaSlot {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid
  startsAt  DateTime
  endsAt    DateTime
  capacity  Int
  status    String   @default("AVAILABLE")
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?  @db.Uuid
  updatedBy String?  @db.Uuid

  tenant Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  items  TelepericiaSlotItem[]

  @@index([tenantId, startsAt, status])
}

model TelepericiaSlotItem {
  id            String    @id @default(uuid()) @db.Uuid
  tenantId      String    @db.Uuid
  slotId        String    @db.Uuid
  periciaId     String?   @db.Uuid
  appointmentId String?
  orderIndex    Int
  startsAt      DateTime?
  endsAt        DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  createdBy     String?   @db.Uuid
  updatedBy     String?   @db.Uuid

  tenant  Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  slot    TelepericiaSlot @relation(fields: [slotId], references: [id], onDelete: Cascade)
  pericia Pericia?        @relation(fields: [periciaId], references: [id], onDelete: SetNull)

  @@unique([slotId, periciaId])
  @@unique([slotId, appointmentId])
  @@index([tenantId, slotId, orderIndex])
}

model Lawyer {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String   @db.Uuid
  nome        String
  oab         String?
  ufOab       String?  @db.Char(2)
  email       String?
  telefone    String?
  observacoes String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?  @db.Uuid
  updatedBy   String?  @db.Uuid

  tenant   Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  pericias LawyerOnPericia[]

  @@index([tenantId, nome])
}

model LawyerOnPericia {
  id         String   @id @default(uuid()) @db.Uuid
  tenantId   String   @db.Uuid
  periciaId  String   @db.Uuid
  lawyerId   String   @db.Uuid
  roleInCase String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  createdBy  String?  @db.Uuid
  updatedBy  String?  @db.Uuid

  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  pericia Pericia @relation(fields: [periciaId], references: [id], onDelete: Cascade)
  lawyer  Lawyer  @relation(fields: [lawyerId], references: [id], onDelete: Cascade)

  @@unique([tenantId, periciaId, lawyerId])
  @@index([tenantId, lawyerId])
}

model CaseDocument {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String   @db.Uuid
  periciaId   String   @db.Uuid
  nome        String
  tipo        String?
  categoria   String?
  storagePath String?
  mimeType    String?
  fileSize    Int?
  hashSha256  String?
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?  @db.Uuid
  updatedBy   String?  @db.Uuid

  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  pericia Pericia @relation(fields: [periciaId], references: [id], onDelete: Cascade)

  @@index([tenantId, periciaId])
}

model PreLaudo {
  id                    String    @id @default(uuid()) @db.Uuid
  tenantId              String    @db.Uuid
  periciaId             String    @unique @db.Uuid
  sections              Json?
  aiAnalysis            Json?
  laudoV2               Json?
  laudoRealtime         Json?
  templateName          String?
  templateDocxPath      String?
  lastGeneratedPdfPath  String?
  initialProcessJson    Json?
  initialManeuvers      String[]
  exameFisicoTexto      String?
  discussaoTecnicaTexto String?
  version               Int       @default(1)
  lockedByUserId        String?   @db.Uuid
  lockedAt              DateTime?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  createdBy             String?   @db.Uuid
  updatedBy             String?   @db.Uuid

  tenant       Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  pericia      Pericia @relation(fields: [periciaId], references: [id], onDelete: Cascade)
  lockedByUser User?   @relation("PreLaudoLockedBy", fields: [lockedByUserId], references: [id], onDelete: SetNull)

  @@index([tenantId, periciaId])
}

model ExamPlan {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String   @db.Uuid
  periciaId   String   @db.Uuid
  title       String
  description String?
  orderIndex  Int      @default(0)
  payload     Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?  @db.Uuid
  updatedBy   String?  @db.Uuid

  tenant         Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  pericia        Pericia         @relation(fields: [periciaId], references: [id], onDelete: Cascade)
  examsPerformed ExamPerformed[]

  @@index([tenantId, periciaId])
}

model ExamPerformed {
  id         String     @id @default(uuid()) @db.Uuid
  tenantId   String     @db.Uuid
  periciaId  String     @db.Uuid
  examPlanId String?    @db.Uuid
  status     ExamStatus @default(NOT_STARTED)
  findings   Json?
  transcript Json?
  startedAt  DateTime?
  finishedAt DateTime?
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  createdBy  String?    @db.Uuid
  updatedBy  String?    @db.Uuid

  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  pericia  Pericia   @relation(fields: [periciaId], references: [id], onDelete: Cascade)
  examPlan ExamPlan? @relation(fields: [examPlanId], references: [id], onDelete: SetNull)

  @@index([tenantId, periciaId])
}

model PhysicalManeuver {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid
  name      String
  category  String?
  summary   String?
  procedure Json?
  evidence  Json?
  tags      String[]
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?  @db.Uuid
  updatedBy String?  @db.Uuid

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, name])
}

model KnowledgeItem {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid
  title     String
  category  String?
  content   Json?
  source    String?
  tags      String[]
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?  @db.Uuid
  updatedBy String?  @db.Uuid

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, title])
}

model AgendaEvent {
  id           String         @id @default(uuid()) @db.Uuid
  tenantId     String         @db.Uuid
  periciaId    String?        @db.Uuid
  cnjId        String?
  cityId       String?        @db.Uuid
  city         String?
  title        String
  description  String?
  type         AgendaEventType
  status       AgendaEventStatus @default(AGENDADA)
  source       AgendaEventSource @default(MANUAL)
  aiSuggested  Boolean        @default(false)
  statusHistory Json?
  syncStatus   ExternalSyncStatus @default(PENDING)
  syncErrorMessage String?
  externalProvider String?
  externalEventId String?
  externalEtag String?
  externalLastModifiedAt DateTime?
  startAt      DateTime
  endAt        DateTime?
  allDay       Boolean        @default(false)
  location     String?
  metadata     Json?
  externalId   String?
  externalCalendarId String?
  externalLastModifiedAt DateTime?
  lastSyncAt   DateTime?
  syncStatus   CalendarSyncStatus @default(PENDING)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  createdBy    String?        @db.Uuid
  updatedBy    String?        @db.Uuid

  tenant  Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  pericia Pericia? @relation(fields: [periciaId], references: [id], onDelete: SetNull)
  cityRef Cidade? @relation(fields: [cityId], references: [id], onDelete: SetNull)

  @@index([tenantId, startAt])
  @@index([tenantId, periciaId, startAt])
  @@index([tenantId, status, startAt])
  @@index([tenantId, syncStatus])
  @@index([tenantId, externalProvider, externalEventId])
}

model AgendaTask {
  id           String          @id @default(uuid()) @db.Uuid
  tenantId     String          @db.Uuid
  periciaId    String?         @db.Uuid
  title        String
  description  String?
  dueAt        DateTime?
  status       AgendaTaskStatus @default(TODO)
  priority     Int             @default(3)
  completedAt  DateTime?
  metadata     Json?
  externalId   String?
  externalCalendarId String?
  externalLastModifiedAt DateTime?
  lastSyncAt   DateTime?
  syncStatus   CalendarSyncStatus @default(PENDING)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  createdBy    String?         @db.Uuid
  updatedBy    String?         @db.Uuid

  tenant  Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  pericia Pericia? @relation(fields: [periciaId], references: [id], onDelete: SetNull)

  @@index([tenantId, dueAt, status])
  @@index([tenantId, externalId])
}

// =========================
// Financeiro
// =========================

model Recebimento {
  id              String         @id @default(uuid()) @db.Uuid
  tenantId        String         @db.Uuid
  periciaId       String         @db.Uuid
  importBatchId   String?        @db.Uuid
  payerId         String?        @db.Uuid
  fontePagamento  FontePagamento
  dataRecebimento DateTime
  valorBruto      Decimal        @db.Decimal(12, 2)
  valorLiquido    Decimal?       @db.Decimal(12, 2)
  tarifa          Decimal?       @db.Decimal(12, 2)
  desconto        Decimal?       @db.Decimal(12, 2)
  descricao       String?
  metadata        Json?
  deletedAt       DateTime?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  createdBy       String?        @db.Uuid
  updatedBy       String?        @db.Uuid

  tenant      Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  pericia     Pericia      @relation(fields: [periciaId], references: [id], onDelete: Cascade)
  importBatch ImportBatch? @relation(fields: [importBatchId], references: [id], onDelete: SetNull)
  payer       Payer?       @relation(fields: [payerId], references: [id], onDelete: SetNull)

  @@index([tenantId, periciaId, dataRecebimento])
}

model ImportBatch {
  id               String   @id @default(uuid()) @db.Uuid
  tenantId         String   @db.Uuid
  referenceMonth   Int?
  referenceYear    Int?
  sourceFileName   String?
  sourceHash       String?
  importedAt       DateTime @default(now())
  totalRecords     Int      @default(0)
  matchedRecords   Int      @default(0)
  unmatchedRecords Int      @default(0)
  status           String?
  metadata         Json?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  createdBy        String?  @db.Uuid
  updatedBy        String?  @db.Uuid

  tenant            Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  recebimentos      Recebimento[]
  unmatchedPayments UnmatchedPayment[]

  @@index([tenantId, importedAt])
}

model UnmatchedPayment {
  id              String             @id @default(uuid()) @db.Uuid
  tenantId        String             @db.Uuid
  importBatchId   String?            @db.Uuid
  rawData         Json
  amount          Decimal?           @db.Decimal(12, 2)
  transactionDate DateTime?
  payerName       String?
  matchStatus     PaymentMatchStatus @default(UNMATCHED)
  notes           String?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  createdBy       String?            @db.Uuid
  updatedBy       String?            @db.Uuid

  tenant      Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  importBatch ImportBatch? @relation(fields: [importBatchId], references: [id], onDelete: SetNull)

  @@index([tenantId, matchStatus, transactionDate])
}

model Despesa {
  id              String    @id @default(uuid()) @db.Uuid
  tenantId        String    @db.Uuid
  periciaId       String?   @db.Uuid
  categoria       String
  descricao       String
  valor           Decimal   @db.Decimal(12, 2)
  dataCompetencia DateTime
  comprovantePath String?
  metadata        Json?
  deletedAt       DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  createdBy       String?   @db.Uuid
  updatedBy       String?   @db.Uuid

  tenant  Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  pericia Pericia? @relation(fields: [periciaId], references: [id], onDelete: SetNull)

  @@index([tenantId, dataCompetencia])
}

model BankTransaction {
  id              String             @id @default(uuid()) @db.Uuid
  tenantId        String             @db.Uuid
  periciaId       String?            @db.Uuid
  externalId      String?
  direction       FinancialDirection
  transactionDate DateTime
  amount          Decimal            @db.Decimal(12, 2)
  description     String?
  document        String?
  rawPayload      Json?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  createdBy       String?            @db.Uuid
  updatedBy       String?            @db.Uuid

  tenant  Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  pericia Pericia? @relation(fields: [periciaId], references: [id], onDelete: SetNull)

  @@index([tenantId, transactionDate, direction])
}

model CashLedgerItem {
  id            String             @id @default(uuid()) @db.Uuid
  tenantId      String             @db.Uuid
  direction     FinancialDirection
  amount        Decimal            @db.Decimal(12, 2)
  occurredAt    DateTime
  referenceType String?
  referenceId   String?
  note          String?
  metadata      Json?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  createdBy     String?            @db.Uuid
  updatedBy     String?            @db.Uuid

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, occurredAt])
}

model PaymentProfile {
  id            String   @id @default(uuid()) @db.Uuid
  tenantId      String   @db.Uuid
  legalName     String
  document      String?
  pixKey        String?
  bankName      String?
  branch        String?
  accountNumber String?
  accountType   String?
  metadata      Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  createdBy     String?  @db.Uuid
  updatedBy     String?  @db.Uuid

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, legalName])
}

model Payer {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid
  nome      String
  documento String?
  tipo      String?
  email     String?
  phone     String?
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?  @db.Uuid
  updatedBy String?  @db.Uuid

  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  recebimentos Recebimento[]

  @@index([tenantId, nome])
}

// =========================
// Regras / automação / auditoria
// =========================

model SmartRule {
  id            String      @id @default(uuid()) @db.Uuid
  tenantId      String      @db.Uuid
  name          String
  description   String?
  trigger       RuleTrigger
  conditionJson Json
  actionJson    Json
  isActive      Boolean     @default(true)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  createdBy     String?     @db.Uuid
  updatedBy     String?     @db.Uuid

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, trigger, isActive])
}

model AutomationRule {
  id            String      @id @default(uuid()) @db.Uuid
  tenantId      String      @db.Uuid
  name          String
  trigger       RuleTrigger
  action        RuleAction
  conditionJson Json?
  configJson    Json
  isActive      Boolean     @default(true)
  lastRunAt     DateTime?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  createdBy     String?     @db.Uuid
  updatedBy     String?     @db.Uuid

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, isActive, trigger])
}

model LogStatus {
  id             String   @id @default(uuid()) @db.Uuid
  tenantId       String   @db.Uuid
  periciaId      String   @db.Uuid
  statusAnterior String?
  statusNovo     String
  motivo         String?
  metadata       Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  createdBy      String?  @db.Uuid
  updatedBy      String?  @db.Uuid

  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  pericia Pericia @relation(fields: [periciaId], references: [id], onDelete: Cascade)

  @@index([tenantId, periciaId, createdAt])
}

model ActivityLog {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String   @db.Uuid
  entityType  String
  entityId    String
  action      String
  payloadJson Json?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?  @db.Uuid
  updatedBy   String?  @db.Uuid

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, entityType, entityId, createdAt])
}

model WhatsappMessage {
  id               String   @id @default(uuid()) @db.Uuid
  tenantId         String   @db.Uuid
  periciaId        String?  @db.Uuid
  provider         String   @default("whatsapp-cloud-api")
  eventType        String
  direction        String
  status           String?
  waMessageId      String?
  fromPhone        String?
  toPhone          String?
  messageBody      String?
  errorCode        String?
  errorMessage     String?
  payloadJson      Json?
  providerResponse Json?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  createdBy        String?  @db.Uuid
  updatedBy        String?  @db.Uuid

  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  pericia Pericia? @relation(fields: [periciaId], references: [id], onDelete: SetNull)

  @@index([tenantId, periciaId, createdAt])
  @@index([tenantId, waMessageId])
  @@index([tenantId, status, createdAt])
}

model DailyUsage {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String   @db.Uuid
  usageDate   DateTime
  metricKey   String
  metricValue Int
  context     Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?  @db.Uuid
  updatedBy   String?  @db.Uuid

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, usageDate, metricKey])
}

model EmailConfig {
  id             String   @id @default(uuid()) @db.Uuid
  tenantId       String   @db.Uuid
  provider       String
  fromEmail      String
  fromName       String?
  smtpHost       String?
  smtpPort       Int?
  secure         Boolean  @default(true)
  encryptedCreds String?
  active         Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  createdBy      String?  @db.Uuid
  updatedBy      String?  @db.Uuid

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

model EmailTemplate {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid
  key       String
  subject   String
  bodyHtml  String
  bodyText  String?
  variables Json?
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?  @db.Uuid
  updatedBy String?  @db.Uuid

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, key])
}


model MessageTemplate {
  id               String   @id @default(uuid()) @db.Uuid
  tenantId         String   @db.Uuid
  channel          String
  name             String
  body             String
  placeholdersUsed Json?
  variablesMapping Json?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  createdBy        String?  @db.Uuid
  updatedBy        String?  @db.Uuid

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, channel, createdAt])
}

model IntegrationSettings {
  id            String   @id @default(uuid()) @db.Uuid
  tenantId      String   @db.Uuid
  provider      String
  config        Json
  encryptedKeys String?
  active        Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  createdBy     String?  @db.Uuid
  updatedBy     String?  @db.Uuid

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, provider])
}

model CalendarIntegration {
  id                    String           @id @default(uuid()) @db.Uuid
  tenantId              String           @db.Uuid
  provider              String           @default("GOOGLE")
  email                 String?
  accessToken           String?
  refreshToken          String?
  tokenExpiresAt        DateTime?
  selectedCalendarId    String?
  selectedCalendarName  String?
  syncEvents            Boolean          @default(true)
  syncTasks             Boolean          @default(false)
  mode                  CalendarSyncMode @default(MIRROR)
  active                Boolean          @default(false)
  lastSyncAt            DateTime?
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  createdBy             String?          @db.Uuid
  updatedBy             String?          @db.Uuid

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  syncAuditLogs SyncAuditLog[]

  @@unique([tenantId, provider])
}

model SyncAuditLog {
  id                String                @id @default(uuid()) @db.Uuid
  tenantId          String                @db.Uuid
  integrationId     String?               @db.Uuid
  syncType          CalendarSyncType
  direction         CalendarSyncDirection
  localEntity       String
  localEntityId     String                @db.Uuid
  externalId        String?
  status            CalendarSyncStatus
  message           String?
  localUpdatedAt    DateTime?
  externalUpdatedAt DateTime?
  syncedAt          DateTime?
  payload           Json?
  createdAt         DateTime              @default(now())

  tenant      Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  integration CalendarIntegration? @relation(fields: [integrationId], references: [id], onDelete: SetNull)

  @@index([tenantId, createdAt])
  @@index([tenantId, syncType, status])
}

model NotificationConfig {
  id        String              @id @default(uuid()) @db.Uuid
  tenantId  String              @db.Uuid
  channel   NotificationChannel
  enabled   Boolean             @default(true)
  config    Json?
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt
  createdBy String?             @db.Uuid
  updatedBy String?             @db.Uuid

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, channel])
}

model TelepericiaSlot {
  id                         String              @id @default(uuid()) @db.Uuid
  tenantId                   String              @db.Uuid
  date                       DateTime            @db.Date
  startTime                  String              @map("start_time") @db.VarChar(5)
  durationMinutes            Int                 @map("duration_minutes")
  slotType                   TelepericiaSlotType @default(SEQUENTIAL) @map("slot_type")
  appointmentDurationMinutes Int                 @map("appointment_duration_minutes")
  gapMinutes                 Int                 @default(0) @map("gap_minutes")
  capacity                   Int                 @default(1)
  timezone                   String              @default("America/Sao_Paulo")
  metadata                   Json?
  createdAt                  DateTime            @default(now())
  updatedAt                  DateTime            @updatedAt
  createdBy                  String?             @db.Uuid
  updatedBy                  String?             @db.Uuid

  tenant Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  items  TelepericiaSlotItem[]

  @@map("telepericia_slots")
  @@index([tenantId, date])
}

model TelepericiaSlotItem {
  id         String   @id @default(uuid()) @db.Uuid
  tenantId   String   @db.Uuid
  slotId     String   @db.Uuid
  periciaId  String   @db.Uuid
  orderIndex Int      @map("order_index")
  metadata   Json?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  createdBy  String?  @db.Uuid
  updatedBy  String?  @db.Uuid

  tenant  Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  slot    TelepericiaSlot @relation(fields: [slotId], references: [id], onDelete: Cascade)
  pericia Pericia        @relation(fields: [periciaId], references: [id], onDelete: Cascade)

  @@unique([slotId, periciaId])
  @@unique([slotId, orderIndex])
  @@map("telepericia_slot_items")
  @@index([tenantId, slotId])
}

model SchedulingBatch {
  id           String   @id @default(uuid()) @db.Uuid
  tenantId     String   @db.Uuid
  cidadeId     String?  @db.Uuid
  dateRef      DateTime
  criteriaJson Json?
  resultJson   Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  createdBy    String?  @db.Uuid
  updatedBy    String?  @db.Uuid

  tenant Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  cidade Cidade? @relation(fields: [cidadeId], references: [id], onDelete: SetNull)

  @@index([tenantId, dateRef])
}

model CnjSync {
  id         String        @id @default(uuid()) @db.Uuid
  tenantId   String        @db.Uuid
  periciaId  String?       @db.Uuid
  status     CnjSyncStatus @default(PENDING)
  lastSyncAt DateTime?
  nextSyncAt DateTime?
  retries    Int           @default(0)
  message    String?
  payload    Json?
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  createdBy  String?       @db.Uuid
  updatedBy  String?       @db.Uuid

  tenant  Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  pericia Pericia? @relation(fields: [periciaId], references: [id], onDelete: SetNull)

  @@index([tenantId, status, nextSyncAt])
}

model WhatsAppJob {
  id             String            @id @default(uuid()) @db.Uuid
  tenantId       String            @db.Uuid
  periciaId      String            @db.Uuid
  jobType        WhatsAppJobType
  status         WhatsAppJobStatus @default(QUEUED)
  scheduledFor   DateTime
  nextAttemptAt  DateTime?
  attempts       Int               @default(0)
  maxAttempts    Int               @default(4)
  idempotencyKey String
  phone          String?
  payload        Json?
  lastError      Json?
  providerRef    String?
  sentAt         DateTime?
  canceledAt     DateTime?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  createdBy      String?           @db.Uuid
  updatedBy      String?           @db.Uuid

  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  pericia Pericia @relation(fields: [periciaId], references: [id], onDelete: Cascade)

  @@unique([tenantId, idempotencyKey])
  @@index([tenantId, status, scheduledFor])
  @@index([tenantId, periciaId, jobType])
}
